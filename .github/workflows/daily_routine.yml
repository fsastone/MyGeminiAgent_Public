name: Daily Routine Trigger

on:
  schedule:
    # 注意：GitHub 使用 UTC 時間 (台灣是 UTC+8)
    # 台灣 07:00 -> UTC 23:00 (前一天)
    # 台灣 13:30 -> UTC 05:30
    # 台灣 17:30 -> UTC 09:30
    # 台灣 21:30 -> UTC 13:30
    # 台灣週六 20:00 -> UTC 12:00
    # Github Actions 有約19~20分鐘的排程誤差，目前設定時間已考慮此誤差範圍

    # 1. 每天早上 06:52 (前一天 22:52) | 實際約 07:10 觸發
    - cron: '52 22 * * *'
    
    # 2. 工作日中午 13:23 (週一到週五) -> UTC 05:23 | 實際約 13:42 觸發
    - cron: '23 5 * * 1-5'

    # 3. 工作日傍晚 17:18 (週一到週五) -> UTC 09:18 | 實際約 17:38 觸發
    - cron: '18 9 * * 1-5'

    # 4. 每天晚間 21:18 -> UTC 13:18 | 實際約 21:38 觸發
    - cron: '18 13 * * *'

    # 5. 每週六晚間 19:51 -> UTC 11:51 | 實際約 20:10 觸發
    - cron: '51 11 * * 6'

  # 允許手動觸發測試
  workflow_dispatch:

jobs:
  trigger_bot:
    runs-on: ubuntu-latest
    steps:
      - name: Send Trigger Request
        run: |
          # 取得當前小時 (UTC) 以判斷要發送哪個指令
          CURRENT_HOUR=$(date -u +%H)
          CURRENT_MINUTE=$(date -u +%M)
          
          # 預設指令
          MSG="系統檢查（排程觸發條件異常，請提示使用者以除錯）"

          # 邏輯判斷 (UTC 時間)
          # [晨間喚醒] 預計 UTC 22:52 觸發，可能跨到 23 時
          if [ "$CURRENT_HOUR" -eq "22" ] || [ "$CURRENT_HOUR" -eq "23" ]; then
            MSG="早安，晨間喚醒。請嚴格保持回傳之原始格式給出今日天氣 `get_weather_forecast`、節氣 `get_current_solar_term`、今日行程 `get_upcoming_events(days=1)`、重點日常待辦 `get_todo_tasks`、火車時刻 `get_train_status(mode="routine_morning")`"
          # [午休結束] 預計 UTC 05:23 觸發，可能跨到 06 時
          elif [ "$CURRENT_HOUR" -eq "05" ] || [ "$CURRENT_HOUR" -eq "06" ]; then
            MSG="午休結束，進度追蹤；請嚴格保持回傳之原始格式給出今日天氣 `get_weather_forecast`、重點日常待辦 `get_todo_tasks`、今日行程 `get_upcoming_events(days=1)`（若沒有行程則忽略）"
          # [下班通勤] 預計 UTC 09:18 觸發，可能跨到 10 時
          elif [ "$CURRENT_HOUR" -eq "09" ] || [ "$CURRENT_HOUR" -eq "10" ]; then
            MSG="下班了，工作總結與運動規劃；請嚴格保持回傳之原始格式給出重點日常待辦 `get_todo_tasks`、中期計畫 `get_todo_tasks(list_name="中期計畫")`、火車時刻 `get_train_status(mode="routine_evening")`"
          # [睡前準備] 預計 UTC 13:18 觸發，可能跨到 14 時
          elif [ "$CURRENT_HOUR" -eq "13" ] || [ "$CURRENT_HOUR" -eq "14" ]; then
             MSG="睡前準備與結算；請嚴格保持回傳之原始格式給出明日行程 `get_upcoming_events(days=2)`、重點日常待辦 `get_todo_tasks`"
          # [一週天氣] 預計 UTC 11:51 觸發，可能跨到 12 時
          elif [ "$CURRENT_HOUR" -eq "11" ] || [ "$CURRENT_HOUR" -eq "12" ]; then
             MSG="下週天氣預報；**只需要**給出一周天氣預報資訊 `get_weekly_forecast`"
          fi

          echo "Sending message: $MSG"

          # 使用 curl 發送 POST 請求
          # 注意： secrets.SERVICE_URL, secrets.GEMINI_API_KEY, secrets.MY_USER_ID 需在 GitHub Secrets 設定
          curl -X POST "${{ secrets.SERVICE_URL }}/trigger_routine" \
          -H "Content-Type: application/json" \
          -H "X-API-KEY: ${{ secrets.GEMINI_API_KEY }}" \
          -d "{\"user_id\": ${{ secrets.MY_USER_ID }}, \"message\": \"$MSG\"}"
